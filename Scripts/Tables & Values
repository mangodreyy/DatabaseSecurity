-- TABLES -- 
-- Department Table
CREATE TABLE Department (
	DepartmentID VARCHAR(10) NOT NULL PRIMARY KEY,
	DepartmentName VARCHAR(100) UNIQUE NOT NULL
);
GO

-- Database Administrations Table [DBA]
-- Software Developers Team Table [SDEV]
-- Accounting Team Table [ACC]
-- Human Resources Team Table [HR]
-- Marketing Development Table [MKT]
-- Administration Table [ADMIN]

-- Employee Table
CREATE TABLE Employees (
	EmployeeID INT IDENTITY(1,1) NOT NULL PRIMARY KEY, 
	DepartmentID VARCHAR(10) FOREIGN KEY REFERENCES Department(DepartmentID),
	Status NVARCHAR(20) DEFAULT 'ACTIVE',
	RoleInDepartment VARCHAR(50) CHECK (RoleInDepartment IN ('Manager', 'Team Member')),
	FullName VARCHAR(100) NOT NULL,
	Email NVARCHAR(100),
	Phone NVARCHAR(20) NOT NULL,
	MaritialStatus VARCHAR(50) CHECK (MaritialStatus IN ('Single','Married')),
	EmergencyContact NVARCHAR(20) NOT NULL,
	Relationship VARCHAR(50) CHECK (Relationship IN ('Father', 'Mother','Spouse','Siblings')),
	Address NVARCHAR (255),
	CreatedAt DATETIME DEFAULT GETDATE()
);
GO

-- Agents Table [AGENT]
CREATE TABLE Agents (
	AgentID INT NOT NULL PRIMARY KEY FOREIGN KEY REFERENCES Employees(EmployeeID),
	RoleInDepartment VARCHAR(50) CHECK (RoleInDepartment IN ('Team Lead', 'Member')),
	FullName VARCHAR(100) NOT NULL,
	Email NVARCHAR(100),
	Phone NVARCHAR(20) NOT NULL,
	Region NVARCHAR(200) NOT NULL CHECK (Region IN ('BukitJalil','Puchong','PetalingJaya','Klang', 'Shah Alam')),
	Address NVARCHAR (255)
);
GO

-- Customer Table
CREATE TABLE Customers (
	CustID VARCHAR(5) NOT NULL PRIMARY KEY,
	CustName varchar(100) NOT NULL,
	Phone varchar(20),
	Email varchar(200),
	Address varchar(255)
);
GO

-- Front End User Account Table
CREATE TABLE AppUsers (
	UserID INT IDENTITY(1,1) NOT NULL PRIMARY KEY, 
    -- Login Credentials
    Username VARCHAR(100) NOT NULL UNIQUE, 
    PasswordHash VARBINARY(256) NOT NULL, -- Store the securely hashed password
    UserType VARCHAR(10) NOT NULL CHECK (UserType IN ('EMPLOYEE', 'CUSTOMER')),
    
    -- Links to Profile Tables (One of these must be NULL)
    EmployeeID INT NULL, 
    CustID VARCHAR(5) NULL, 
    
    -- Security Fields
    LastLogin DATETIME NULL,
    IsActive BIT DEFAULT 1,

    -- Foreign Key Constraints (Ensure only one link is active)
    FOREIGN KEY (EmployeeID) REFERENCES Employees(EmployeeID),
    FOREIGN KEY (CustID) REFERENCES Customers(CustID),

    -- CONSTRAINT to enforce that a UserID links to EITHER an Employee OR a Customer, but not both, and not neither.
    CONSTRAINT CHK_One_Profile_Link 
        CHECK (
            (CASE WHEN EmployeeID IS NOT NULL THEN 1 ELSE 0 END + 
             CASE WHEN CustID IS NOT NULL THEN 1 ELSE 0 END) = 1
        )
);
GO

-- Products Table
-- status: instock outstock / available unavailable
CREATE TABLE Products (
	ProductID INT IDENTITY(1,1) NOT NULL PRIMARY KEY,
	ProductName NVARCHAR(100) NOT NULL,
	ProductDescription NVARCHAR(255),
	BasePrice DECIMAL(10,2) NOT NULL,
	SellingPrice DECIMAL(10,2) NOT NULL,
	CreatedAt DATETIME DEFAULT GETDATE()
);
GO

-- Sales (Invoice) Table
CREATE TABLE Sales (
	SalesID INT IDENTITY(1,1) NOT NULL PRIMARY KEY,
	AgentID INT NOT NULL FOREIGN KEY REFERENCES Agents(AgentID),
	CustID VARCHAR(5) NOT NULL FOREIGN KEY REFERENCES Customers(CustID),
	TotalAmount DECIMAL(10,2) NOT NULL,
	SalesDate DATETIME DEFAULT GETDATE(),
	PaymentStatus CHAR(10) CHECK (PaymentStatus IN ('PAID','PENDING','CANCELLED')),
	PaymentMethod CHAR(50) CHECK (PaymentMethod IN ('Online Banking','E-Wallet','Credit Card','CashOnDelivery')),
	DeliveryAddress NVARCHAR (255)
);
GO

-- Sales Details Table
CREATE TABLE SalesDetails (
	SalesID INT NOT NULL FOREIGN KEY REFERENCES Sales(SalesID),
	ProductID INT NOT NULL FOREIGN KEY REFERENCES Products(ProductID),
	--pull selling price
	Quantity INT NOT NULL,
	Amount DECIMAL (10,2) NOT NULL
); 
GO

CREATE TABLE CommissionRates (
	RateID INT IDENTITY(1,1) NOT NULL PRIMARY KEY,
	RoleInDepartment VARCHAR(50) NOT NULL CHECK (RoleInDepartment IN ('Team Lead','Member')),
	CommissionRate DECIMAL(5,2) NOT NULL,
	EffectiveRate DATETIME DEFAULT GETDATE(),
);
GO

-- Commission Table
CREATE TABLE Commission (
	CommissionID INT IDENTITY(1,1) NOT NULL PRIMARY KEY,
	SalesID INT NOT NULL FOREIGN KEY REFERENCES Sales(SalesID),
	AgentID INT NOT NULL FOREIGN KEY REFERENCES Agents(AgentID),
	SalesAmount DECIMAL (10,2) NOT NULL,
	CommissionRate DECIMAL (5,2) NOT NULL,
	CommissionAmount DECIMAL(10,2) NOT NULL,
	CONSTRAINT One_Commission_Per_Sale UNIQUE (SalesID),
);
GO

-- Value Insertion --
INSERT INTO Department VALUES
('DBA', 'Database Administration'),
('SDEV', 'Software Development'),
('ACC', 'Accounting'),
('HR', 'Human Resources'),
('MKT', 'Marketing Development'),
('ADMIN','Administation'),
('AGENT','Agents');
GO

INSERT INTO CommissionRates (RoleInDepartment, CommissionRate) VALUES
('Team Lead',7.50),
('Member',5.00);
GO
